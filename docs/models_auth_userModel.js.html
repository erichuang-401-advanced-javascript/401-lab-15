<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: models/auth/userModel.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: models/auth/userModel.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

const mongoose = require('mongoose');
const bcrypt = require('bcrypt');
const jwt = require('jsonwebtoken');

const user = new mongoose.Schema({
  username : { type : String, required : true, unique : true },
  password : { type : String, required : true },
  role : { type : String, default : 'user', enum : ['user', 'admin'] },
});

/**
 * Pre-hook hashes password on .save()ing a new user during sign up.
 * @param next
 */
user.pre( 'save', function( next ) {
  bcrypt.hash( this.password, 10 )
    .then( hashedPassword => {
      this.password = hashedPassword;
      next();
    })
    .catch( console.error );
});

/**
 * Queries by username and then compares the submitted password against the password in DB. Returns user if verified.
 * @param credentials
 * @returns {Promise&lt;unknown>}
 */
user.statics.basicAuth = function ( credentials ) {
  let query = { username : credentials.username };
  return this.findOne( query )
    .then( user => {
      if ( user &amp;&amp; user.comparePassword( credentials.password ) ) {
        return user;
      } else console.log('Invalid password.');
    })
    .catch( error => console.log('Basic Auth:', error ) );
};

/**
 * Verifies token and uses payload ID to search for user ID in DB. Returns user if found.
 * @param token
 * @returns {Promise&lt;unknown>}
 */
user.statics.tokenAuth = function ( token ) {
  let payload = jwt.verify( token, process.env.SECRET );
  return this.findById( payload.id )
    .then( user => {
      return user ? user : null;
    })
    .catch( error => console.log('Token Auth:', error) );
};

/**
 * Helper function for basic auth. Compares submitted password against DB password and returns true or false.
 * @param passwordString
 * @returns {Promise&lt;unknown>}
 */
user.methods.comparePassword = function ( passwordString ) {
  return bcrypt.compare( passwordString, this.password )
    .then( valid => valid ? this : null )
    .catch( error => console.log('PW compare:', error ));
};

/**
 * Generates a token with the user's ID.
 * @returns {undefined|*}
 */
user.methods.generateToken = function () {
  let payload = { id : this._id };
  return jwt.sign( payload, process.env.SECRET );
};

module.exports = mongoose.model( 'user', user );
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="ModelCRUD.html">ModelCRUD</a></li></ul><h3>Global</h3><ul><li><a href="global.html#authenticate">authenticate</a></li><li><a href="global.html#error404">error404</a></li><li><a href="global.html#errorHandler">errorHandler</a></li><li><a href="global.html#modelLoader">modelLoader</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Sun Sep 08 2019 16:08:25 GMT-0700 (Pacific Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
